#!/usr/bin/env node
var qe=Object.defineProperty;var Je=(e,r)=>{for(var t in r)qe(e,t,{get:r[t],enumerable:!0})};import{fileURLToPath as Ze}from"url";import Ve from"path";var Ye=()=>Ze(import.meta.url),Ge=()=>Ve.dirname(Ye()),w=Ge();import $ from"chalk";import Rt from"figlet";import{Command as Et}from"commander";import V from"fs/promises";import p from"chalk";import{createHash as Dt}from"node:crypto";import{eq as C,and as oe}from"drizzle-orm";import{drizzle as Xe}from"drizzle-orm/better-sqlite3";import{migrate as et}from"drizzle-orm/better-sqlite3/migrator";import tt from"better-sqlite3";import ye from"path";var ie={};Je(ie,{callsTable:()=>N,clausesTable:()=>d,definitionsTable:()=>v,scriptDataTable:()=>D,scriptsTable:()=>A,testSpecsTable:()=>B});import{text as u,integer as _,sqliteTable as L,index as Qe}from"drizzle-orm/sqlite-core";var A=L("scripts",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),name:u("name").notNull(),uri:u("uri").notNull(),scriptType:u("script_type").notNull()}),D=L("script_data",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),hash:u("hash").notNull(),scriptId:u("script_id").notNull()},e=>({hashIdx:Qe("hash_idx").on(e.hash)})),B=L("test_specs",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),scriptDataId:u("script_data_id").notNull(),name:u("name").notNull(),description:u("description")}),v=L("definitions",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),testSpecId:u("test_spec_id").notNull(),name:u("name").notNull(),line:_("line").notNull()}),d=L("clauses",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),parentId:u("parent_id").notNull(),type:_("type").notNull(),line:_("line").notNull(),clause:u("clause").notNull()}),N=L("calls",{id:u("id").notNull().primaryKey(),createdAt:u("created_at").notNull(),updatedAt:u("updated_at"),status:_("status").notNull(),testSpecDefinitionId:u("test_spec_definition_id").notNull(),testSpecClauseId:u("test_spec_clause_id").notNull(),externalId:u("external_id"),call:u("call").notNull(),params:u("params").notNull()});import ae from"chalk";var U=null,H=null,q=e=>(H===null&&(U===null&&(U=new tt(ye.join(e,"testabulous.db"))),H=Xe(U,{schema:ie,logger:!1})),H),Y=()=>{console.log(ae.yellow("\u{1F44D} Closing database")),H!=null&&(H=null),U!=null&&(U.close(),U=null)},P=async e=>{let r=q(e);try{let t=ye.join(w,"..","drizzle");console.log(ae.greenBright(`Migrating databases from: ${t}`)),await et(r,{migrationsFolder:t})}catch(t){console.log(ae.redBright(`\u{1F915} Migrating database: ${t}`))}};async function be(e,r){let t=await r.select().from(D).where(C(D.hash,e));if(t.length===0)return null;let s=t[0],n=await r.select().from(A).where(C(A.id,s.scriptId));if(n.length===0)return null;let i=n[0];return i.scriptData=s,i}async function Te(e,r){let t=await r.select().from(D).where(C(D.hash,e));return t.length===0?null:t[0]}async function Se(e,r){let t=await r.select().from(B).where(C(B.scriptDataId,e));if(t.length===0)return null;let s=t[0],n=await r.select().from(d).where(oe(C(d.parentId,s.id),C(d.type,1))).orderBy(d.line);s.givens=n;let i=await r.select().from(v).where(C(v.testSpecId,s.id)).orderBy(v.line);s.definitions=i;for(let o of s.definitions){let l=await r.select().from(d).where(oe(C(d.parentId,o.id),C(d.type,2))).orderBy(d.line);o.givens=l;let a=await r.select().from(d).where(oe(C(d.parentId,o.id),C(d.type,0))).orderBy(d.line);o.steps=a;let m=await r.select().from(N).where(C(N.testSpecDefinitionId,o.id));o.calls=m}return s}import nt from"fs/promises";import R from"chalk";import{eq as F,inArray as $e}from"drizzle-orm";import{createHash as it}from"node:crypto";import pe from"axios";import ve from"fs/promises";import ue from"path";import Ce from"chalk";import k from"fs/promises";import I from"path";import G from"chalk";import le from"untildify";import{z as h}from"zod";var ce=h.enum(["chrome","MicrosoftEdge","firefox","internet explorer","safari"]),De=h.object({projectId:h.string().optional(),apiKey:h.string().optional(),baseDir:h.string().optional().default("testabulous"),uiPort:h.number().optional().default(4e3),apiBaseURL:h.string().url().optional().default("https://testabulous.com/api/v1"),screenshots:h.boolean().optional().default(!1),uploadResults:h.boolean().optional().default(!1),browser:h.object({browser:ce.optional().default("chrome"),headless:h.boolean().optional().default(!1),windowSize:h.object({width:h.number().optional().default(1920),height:h.number().optional().default(1080)}).optional()}).optional().default({browser:"chrome",headless:!0,windowSize:{width:1920,height:1080}}),envFile:h.string().optional()}),rt={rootDir:process.cwd(),baseDir:"testabulous",testsDir:"./tests",cacheDir:"./cache",logsDir:"./logs",scriptsDir:"./scripts",screenshotsDir:"./screenshots",force:!1,debug:!1};async function z(e,r){let t={...rt,...De.parse({}),...r};if(e.rootDir&&e.configFile)throw new Error("Cannot specify both --root-dir and --config-file");let s=t.rootDir,n="testabulous.config.json";if(e.rootDir?(s=le(e.rootDir),n=I.join(s,"testabulous.config.json")):e.configFile&&(s=I.resolve(process.cwd(),I.dirname(le(e.configFile))),n=I.resolve(process.cwd(),le(e.configFile))),t.rootDir=I.isAbsolute(s)?s:I.resolve(process.cwd(),s),console.log(G.greenBright(`Using root directory ${t.rootDir}`)),await K(n))try{let o=await k.readFile(n,{encoding:"utf-8"}),l=De.parse(JSON.parse(o));t={...t,...l},console.log(G.greenBright(`\u{1F680} Loaded config file ${n}`))}catch(o){throw`Config file ${e.configFile} is not parsable: ${o}`}else console.log(G.yellow("\u{1F915} Configuration file not found, using defaults"));if(e.envFile&&(t.envFile=e.envFile),t.envFile)if(t.envFile=I.resolve(t.rootDir,t.envFile),await K(t.envFile))await st(t.envFile),console.log(G.greenBright(`\u{1F680} Loaded environment file ${t.envFile}`));else throw new Error(`\u{1F915} Environment file ${t.envFile} not found`);if(t.apiBaseURL=process.env.TESTABULOUS_API_BASE_URL||t.apiBaseURL,t.projectId=process.env.TESTABULOUS_PROJECT_ID||t.projectId,t.taskId=process.env.TESTABULOUS_TASK_ID,t.apiKey=process.env.TESTABULOUS_API_KEY||t.apiKey,t.testScriptDataId=process.env.TESTABULOUS_TEST_SCRIPT_DATA_ID,process.env.TESTABULOUS_UPLOAD_RESULTS&&(t.uploadResults=(process.env.TESTABULOUS_UPLOAD_RESULTS||"false").toLowerCase()==="true"),e.projectId&&(t.projectId=e.projectId),e.apiKey&&(t.apiKey=e.apiKey),e.port&&(t.uiPort=e.port),t.projectId==="")throw"A Project ID is required";if(t.apiKey==="")throw"An API key is required";return t.testsDir=I.resolve(t.rootDir,t.baseDir,t.testsDir),t.cacheDir=I.resolve(t.rootDir,t.baseDir,t.cacheDir),t.logsDir=I.resolve(t.rootDir,t.baseDir,t.logsDir),t.scriptsDir=I.resolve(t.rootDir,t.baseDir,t.scriptsDir),t.screenshotsDir=I.resolve(t.rootDir,t.baseDir,t.screenshotsDir),await k.mkdir(t.rootDir,{recursive:!0}),await k.mkdir(t.testsDir,{recursive:!0}),await k.mkdir(t.cacheDir,{recursive:!0}),await k.mkdir(t.logsDir,{recursive:!0}),await k.mkdir(t.scriptsDir,{recursive:!0}),await k.mkdir(t.screenshotsDir,{recursive:!0}),t}async function st(e){try{(await k.readFile(e,{encoding:"utf-8"})).split(`
`).forEach(t=>{if(t=t.trim(),t.length===0||t.startsWith("#")||t.startsWith("//"))return;let s=t.indexOf("#");s>-1&&(t=t.substring(0,s).trim());let[n,i]=t.split("=");if(n&&i)process.env[n]=i;else throw new Error(`\u{1F915} Could not parse environment file ${e}: malformed (${t})`)})}catch{throw new Error(`\u{1F915} Could not parse environment file ${e}`)}}async function K(e){return k.stat(e).then(()=>!0).catch(()=>!1)}async function Q(e){let r=[];if(e.file){let t=ue.isAbsolute(e.file)?e.file:ue.resolve(e.testsDir,e.file);if(await K(t))return r.push(t),r;throw`File ${e.file} not found`}else console.log(Ce.blueBright(`\u23F3 Looking for test files in ${e.testsDir}`)),r=await Ie(e.testsDir),console.log(Ce.blueBright(`\u{1F44D} Found ${r.length} test files`));if(r.length===0)throw"No test files found";return r}async function Ie(e){let r=await ve.readdir(e),t=[];for(let s of r){let n=ue.join(e,s);if((await ve.stat(n)).isDirectory()){let o=await Ie(n);t.push(...o)}else n.toLocaleLowerCase().endsWith(".md")&&t.push(n)}return t}async function xe(e){try{let r=await Q(e),t=q(e.cacheDir);await de(r,e,t)}catch(r){console.log(R.redBright(`\u{1F915} Caching files failed: ${r}`))}finally{Y()}}async function de(e,r,t){let s=[];for(let n of e)s.push(await ot(n,r,t));for(let n of s)n.scriptData.status!==1&&(console.log(R.blueBright(`Waiting for processing of ${n.name} to complete`)),await at(n.id,n.scriptData.id,r,t))}async function ot(e,r,t){console.log(R.blueBright(`Processing ${e}`)),r.force&&console.log(R.blueBright(`Forcing re-cache of ${e}`));try{let s=await nt.readFile(e,{encoding:"utf-8"}),n={uri:`file://${e}`,data:s,scriptType:"markdown",forceParse:r.force},i=it("sha256").update(s).digest("base64"),o=await be(i,t);if(!r.force&&o&&o.status===1)return console.log(R.greenBright(`\u{1F44D} ${e} already cached`)),o;let{data:l}=await pe.post(`${r.apiBaseURL}/projects/${r.projectId}/scripts`,n,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${r.apiKey}`}});return await Ae(l,t),console.log(R.greenBright(`\u{1F44D} ${e} cached`)),l}catch(s){throw pe.isAxiosError(s)&&s.response&&s.response.status===402?"You have insufficient credits, please top up your account":(console.log(R.redBright(`\u{1F915} Processing ${e}: ${s}`)),s)}}async function at(e,r,t,s){return new Promise((n,i)=>{let o=new Date,l=setInterval(async()=>{try{console.log(R.blueBright(`Polling for script ${e}`));let{status:a,data:m}=await pe.get(`${t.apiBaseURL}/projects/${t.projectId}/scripts/${e}/data/${r}`,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${t.apiKey}`}});if(a!==200)throw`Server returned ${a}`;if(await Ae(m,s),m.scriptData.status===1){console.log(R.greenBright(`\u{1F44D} ${m.id} cached`)),clearTimeout(l),n(m);return}new Date().getTime()-o.getTime()>6e4&&(clearTimeout(l),i(`Timeout waiting for completion of ${e}`))}catch(a){throw console.log(R.redBright(`\u{1F915} Polling for active script ${e}: ${a}`)),a}},5e3)})}async function Ae(e,r){await r.transaction(async t=>{if((await t.select().from(A).where(F(A.id,e.id))).length===0?await t.insert(A).values({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,status:e.status,name:e.name,uri:e.uri,scriptType:e.scriptType}):await t.update(A).set({updatedAt:e.updatedAt,status:e.status,name:e.name}).where(F(A.id,e.id)),(await t.select().from(D).where(F(D.id,e.scriptData.id))).length===0?await t.insert(D).values({id:e.scriptData.id,createdAt:e.scriptData.createdAt,updatedAt:e.scriptData.updatedAt,status:e.scriptData.status,hash:e.scriptData.hash,scriptId:e.id}):await t.update(D).set({updatedAt:e.scriptData.updatedAt,status:e.scriptData.status}).where(F(D.id,e.scriptData.id)),e.scriptData.spec){(await t.select().from(B).where(F(B.id,e.scriptData.spec.id))).length===0?await t.insert(B).values({id:e.scriptData.spec.id,createdAt:e.scriptData.spec.createdAt,updatedAt:e.scriptData.spec.updatedAt,status:e.scriptData.spec.status,scriptDataId:e.scriptData.id,name:e.scriptData.spec.name,description:e.scriptData.spec.description}):await t.update(B).set({updatedAt:e.scriptData.spec.updatedAt,status:e.scriptData.spec.status,name:e.scriptData.spec.name,description:e.scriptData.spec.description}).where(F(B.id,e.scriptData.spec.id));let o=t.select({data:v.id}).from(v).where(F(v.testSpecId,e.scriptData.spec.id));if(await t.delete(d).where($e(d.parentId,o)),await t.delete(N).where($e(N.testSpecDefinitionId,o)),await t.delete(v).where(F(v.testSpecId,e.scriptData.spec.id)),await t.delete(d).where(F(d.parentId,e.scriptData.spec.id)),e.scriptData.spec.givens)for(let l of e.scriptData.spec.givens)await t.insert(d).values({id:l.id,createdAt:l.createdAt,updatedAt:l.updatedAt,status:l.status,parentId:e.scriptData.spec.id,type:l.type,line:l.line,clause:l.clause});for(let l of e.scriptData.spec.definitions){if(await t.insert(v).values({id:l.id,createdAt:l.createdAt,updatedAt:l.updatedAt,status:l.status,testSpecId:l.testSpecId,name:l.name,line:l.line}),l.givens)for(let a of l.givens)await t.insert(d).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,parentId:l.id,type:a.type,line:a.line,clause:a.clause});if(l.steps)for(let a of l.steps)await t.insert(d).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,parentId:l.id,type:a.type,line:a.line,clause:a.clause});if(l.calls)for(let a of l.calls)await t.insert(N).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,testSpecDefinitionId:a.testSpecDefinitionId,testSpecClauseId:a.testSpecClauseId,externalId:a.externalId,call:a.call,params:a.params})}}})}import{setInterval as Fe}from"timers/promises";import gt from"path";import T from"chalk";import{setInterval as Ee}from"timers/promises";import{By as E}from"selenium-webdriver";import{error as Be}from"selenium-webdriver";import{createId as lt}from"@paralleldrive/cuid2";import{format as ct}from"date-fns";import ut from"axios";import pt from"chalk";var dt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",Re=new Map([["l","abcdefghijklmnopqrstuvwxyz"],["L","ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["n","0123456789"],["s","!@#$%^&*()_+"]]);function ft(e){let r="",t="";for(let o of e){if(/\d/.test(o)){r+=o;continue}Re.has(o)&&(t+=Re.get(o))}let s=8;r>""&&(s=parseInt(r));let n=t;t===""&&(n=dt);let i="";for(let o=0;o<s;o++)i+=n.charAt(Math.floor(Math.random()*n.length));return i}var fe=new Map;fe.set("_random",ft);function X(e,r){let t=r,s=r.match(/\{\{.+?\}\}/g);if(s)for(let n of s){let i=n.substring(2,n.length-2).substring(0,n.length-2).trim();if(e.metadata[i]){t=t.replace(n,e.metadata[i]);continue}if(/^['"“”].*['"“”]$/.test(i)){t=i.substring(1,i.length-1);continue}if(/_\w+\(.*?\)/.test(i)){let o=i.split(/[()]/).filter(l=>l.length>0);if(fe.has(o[0])){let l=fe.get(o[0]);if(o.length>1){t=t.replace(n,l(o[1]));continue}t=t.replace(n,l())}}}return t}async function O(e,r){return new Promise((t,s)=>{(async()=>{let n=null;for await(let i of Ee(250,new Date().valueOf())){if(new Date().valueOf()-i>r){if(n){t(n);return}s(new Error("time out executing step"));return}let l=await e();if(l){if(l.result==="pass"){t(l);return}n=l}}})()})}async function M(e,r,t,s){return new Promise((n,i)=>{(async()=>{for await(let o of Ee(100,new Date().valueOf())){if(new Date().valueOf()-o>s){i(new Error(`time out search for element: ${r}=${t}`));break}let a=null,m=r.toLowerCase();/^aria[- _]/.test(m)&&(m="aria");try{switch(m){case"id":a=await e.browser.findElement(E.id(t));break;case"class":a=await e.browser.findElement(E.className(t));break;case"css selector":case"css":a=await e.browser.findElement(E.css(t));break;case"field":a=await e.browser.findElement(E.name(t));break;case"label":a=await mt(e,r,t);break;case"name":a=await e.browser.findElement(E.css(`*[name='${t}']`));break;case"text":a=await e.browser.findElement(E.xpath(`//*[text()='${t}']`));break;case"button":a=await e.browser.findElement(E.xpath(`//button[text()='${t}']`));break;case"aria":a=await e.browser.findElement(E.css(`*[${r.toLowerCase().replaceAll(/[ _]/g,"-")}='${t}']`));break;default:throw new Error(`unknown identifier type: ${r}`)}}catch(y){if(y instanceof Be.NoSuchElementError||y instanceof Be.StaleElementReferenceError)continue;i(y);return}a&&n(a)}})()})}async function mt(e,r,t){let s=await e.browser.findElement(E.xpath(`//*[contains(text(),'${t}')]`));if(!s)return null;let n=await s.getAttribute("for");return n?await e.browser.findElement(E.id(n)):s}async function _e(e,r){let t=await e.getAttribute("class");return t?t.toString().split(" ").indexOf(r)>=0:!1}function W(e){let r=e.toString();for(;r.length<5;)r=" "+r;return r}function f(e){let r=new Date;return{executionId:lt(),name:e||`Test run: ${ct(r,"yyyy-MM-dd HH:mm:ss")}`,result:"fail",startDate:r,duration:0,passCount:0,failCount:0,skipCount:0,warnCount:0,errorCount:0}}function c(e,r,t){switch(e.result=r,r){case"pass":e.passCount++;break;case"fail":e.failCount++;break;case"skip":e.skipCount++;break;case"warn":e.warnCount++;break;case"error":e.errorCount++;break}return e.message=t,e.endDate=new Date,e.duration=e.endDate.getTime()-e.startDate.getTime(),e}function J(e,r){e.endDate=new Date,e.duration=e.endDate.getTime()-e.startDate.getTime();for(let t of r)e.passCount+=t.passCount,e.failCount+=t.failCount,e.skipCount+=t.skipCount,e.warnCount+=t.warnCount,e.errorCount+=t.errorCount;return e.errorCount>0?e.result="error":e.failCount>0?e.result="fail":e.passCount==0&&e.warnCount>0?e.result="warn":e.passCount==0&&e.skipCount>0?e.result="skip":e.result="pass",e}async function ke(e,r){if(!e.uploadResults)return;let{status:t}=await ut.post(`${e.apiBaseURL}/projects/${e.projectId}/results`,r,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${e.apiKey}`}});if(t!==200)throw`Server returned ${t}`;console.log(pt.yellow("\u{1F44D} Uploaded results to Testabulous"))}var g=new Map;function Ne(e){if(!g.has(e))throw new Error(`test runner call not found: ${e}`);return g.get(e)}var je=new Set;je.add("title");g.set("navigate_to_page",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.url)throw new Error("missing argument: url");try{e.browser.getCurrentUrl()===r.url?await e.browser.navigate().refresh():await e.browser.get(r.url);for await(let n of Fe(1e3,new Date().valueOf())){if(new Date().valueOf()-n>e.timeout)throw new Error("time out waiting for navigation");let o=await e.browser.executeScript("return document.readyState");if(o==="complete"||o==="interactive")break}await e.browser.executeScript(`window.TESTABULOUS_testRunId = "${e.testRunId}"`),c(t,"pass")}catch(s){console.log(T.redBright(`\u{1F915} ${s}`)),c(t,"error",s.toString())}return t});g.set("check_for_page_to_have_attribute",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.value)throw new Error("missing argument: value");let t=r.identifier.toString().toLowerCase();if(!je.has(t))throw new Error(`unsupported identifier: ${t}`);return await O(async()=>{let n={...f(e.currentStep.clause),stepId:e.currentStep.id};try{if(await e.browser.executeScript(`return document.${t}`)==="loading")return;let o=await e.browser.executeScript(`return document.${t}`);return o==r.value?c(n,"pass"):c(n,"fail",`found='${o}', expected='${r.value}'`),n.endDate=new Date,n.duration=n.endDate.valueOf()-n.startDate.valueOf(),n}catch(i){console.log(T.redBright(`\u{1F915} ${i}`)),n.result="error",n.message=i.toString()}},e.timeout)});g.set("click_on_element",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");return await O(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await M(e,r.identifierType,r.identifier,e.timeout);return n?(await n.click(),c(s,"pass"),s):(c(s,"error","element not found"),s)}catch(n){console.log(T.redBright(`\u{1F915} ${n}`)),c(s,"error",n.toString())}},e.timeout)});g.set("enter_text_in_element",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");return await O(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await M(e,r.identifierType,r.identifier,e.timeout);return n?(await n.sendKeys(X(e,r.data)),c(s,"pass"),s):void 0}catch(n){console.log(T.redBright(`\u{1F915} ${n}`)),c(s,"error",n.toString())}},e.timeout)});async function Oe(e,r,t){if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");if(!r.state)throw new Error("missing argument: state");if(!r.stateType)throw new Error("missing argument: stateType");return await O(async()=>{let n={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let i=await M(e,r.identifierType,r.identifier,e.timeout);if(!i)return;let o=!1;switch(r.stateType){case"class":o=await _e(i,r.state);break;default:throw new Error("unknown state type")}return o===t?c(n,"pass"):c(n,"fail",`unexpected state: found='${o}', expected='${t}'`),n}catch(i){console.log(T.redBright(`\u{1F915} ${i}`)),c(n,"error",i.toString())}},e.timeout)}g.set("element_has_property_or_state",async(e,r)=>Oe(e,r,!0));g.set("element_does_not_have_property_or_state",async(e,r)=>Oe(e,r,!1));g.set("element_has_text",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");if(!r.text)throw new Error("missing argument: text");return await O(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await M(e,r.identifierType,r.identifier,e.timeout);if(!n)return;let i=await n.getText();return i===r.text?c(s,"pass"):c(s,"fail",`invalid text: found='${i}', expected='${r.text}'`),s}catch(n){console.log(T.redBright(`\u{1F915} ${n}`)),c(s,"error",n.toString())}},e.timeout)});g.set("wait_for_time_period",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let s=parseInt(r.time);switch(r.unit){case"s":case"second":case"seconds":s=s*1e3;break;case"m":case"minute":case"minutes":s=s*1e3*60;break;case"h":case"hour":case"hours":s=s*1e3*60*60;break;default:throw new Error(`unsupported time unit: ${r.unit}`)}await new Promise(n=>setTimeout(n,s)),c(t,"pass")}catch(s){console.log(T.redBright(`\u{1F915} ${s}`)),c(t,"error",s.toString())}return t});g.set("store_value_in_variable",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.variableName)throw new Error("missing argument: variableName");try{e.metadata[r.variableName]=X(e,r.value),c(t,"pass")}catch(s){console.log(T.redBright(`\u{1F915} ${s}`)),c(t,"error",s.toString())}return t});g.set("check_url_path",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let s=await e.browser.getCurrentUrl(),n=new URL(s);n.pathname===r.path?c(t,"pass"):c(t,"fail",`invalid url path: found='${n.pathname}', expected='${r.path}'`)}catch(s){console.log(T.redBright(`\u{1F915} ${s}`)),c(t,"error",s.toString())}return t});g.set("wait_for_element_to_have_value",async e=>{let r={...f(e.currentStep.clause),stepId:e.currentStep.id};return c(r,"error","not implemented"),r});g.set("load_value_from_environment_variable",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.variableName)throw new Error("missing argument: variableName");if(!r.envVarName)throw new Error("missing argument: envVariableName");try{let s=r.envVarName.startsWith("$")?r.envVarName.slice(1):r.envVarName,n=process.env[s]||"";e.metadata[r.variableName]=X(e,n),c(t,"pass")}catch(s){console.log(T.redBright(`\u{1F915} ${s}`)),c(t,"error",s.toString())}return t});g.set("execute_script",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.scriptName)throw new Error("missing argument: variableName");let s=gt.join(e.scriptsDir,r.scriptName);if(!K(s))throw new Error(`missing script: ${s}`);try{let{default:n}=await import(s),i=await n(e);c(t,i.result,i.message)}catch(n){console.log(T.redBright(`\u{1F915} ${n}`)),c(t,"error",n.toString())}return t});g.set("wait_for_navigation",async e=>{let r={...f(e.currentStep.clause),stepId:e.currentStep.id};try{for await(let t of Fe(1e3,new Date().valueOf())){if(new Date().valueOf()-t>e.timeout)return c(r,"fail","timed out waiting for navigation"),r;let n=await e.browser.executeScript("return document.readyState");if(!(n==="complete"||n==="interactive"))continue;if(!await e.browser.executeScript("return window.TESTABULOUS_testRunId"))break}await e.browser.executeScript(`window.TESTABULOUS_testRunId = "${e.testRunId}"`),c(r,"pass")}catch(t){console.log(T.redBright(`\u{1F915} ${t}`)),c(r,"error",t.toString())}return r});g.set("check_if_element_is_empty",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");return await O(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await M(e,r.identifierType,r.identifier,e.timeout);if(!n)return;let i=await n.findElements({css:"*"});return i.length===0?c(s,"pass"):c(s,"fail",`element not empty: found=${i.length} children`),s}catch(n){console.log(T.redBright(`\u{1F915} ${n}`)),c(s,"error",n.toString())}},e.timeout)});import"chromedriver";import{Builder as wt,logging as me}from"selenium-webdriver";import*as Le from"selenium-webdriver/chrome.js";import ee from"chalk";var j=null;async function ge(e){if(j)return j;console.log(ee.greenBright("\u23F3 Starting web driver"));let r=e.browser?.browser??ce.Values.chrome,t={width:e.browser?.windowSize?.width??1920,height:e.browser?.windowSize?.height??1080},s=e.browser?.headless??!1,n=e.browser?.headless??!1,i=new me.Preferences;i.setLevel(me.Type.BROWSER,me.Level.ALL);let o=new Le.Options;return s&&(o=o.addArguments("--headless=new")),n&&(o=o.addArguments("--disable-gpu")),o=o.addArguments("--no-sandbox"),o=o.addArguments("--disable-dev-shm-usage"),o=o.windowSize(t).setLoggingPrefs(i),console.log(ee.blue(`Staring browser: ${j}`)),console.log(ee.blue(`Screen size: ${t.width}x${t.height}`)),console.log(ee.blue(`Headless: ${s}`)),j=new wt().forBrowser(r).setChromeOptions(o).build(),j}async function we(){j&&await j.quit(),j=null}import{logging as vt}from"selenium-webdriver";import{format as Pe}from"date-fns";import ht from"fs";import yt from"path";import Z from"handlebars";var bt={pass:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
  </svg>`,fail:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z" />
  </svg>`,error:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M6.701 2.25c.577-1 2.02-1 2.598 0l5.196 9a1.5 1.5 0 0 1-1.299 2.25H2.804a1.5 1.5 0 0 1-1.3-2.25l5.197-9ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 1 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
  </svg>`,warn:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M6.701 2.25c.577-1 2.02-1 2.598 0l5.196 9a1.5 1.5 0 0 1-1.299 2.25H2.804a1.5 1.5 0 0 1-1.3-2.25l5.197-9ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 1 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
  </svg>`,skip:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M3.5 9.75A2.75 2.75 0 0 1 6.25 7h5.19L9.22 9.22a.75.75 0 1 0 1.06 1.06l3.5-3.5a.75.75 0 0 0 0-1.06l-3.5-3.5a.75.75 0 1 0-1.06 1.06l2.22 2.22H6.25a4.25 4.25 0 0 0 0 8.5h1a.75.75 0 0 0 0-1.5h-1A2.75 2.75 0 0 1 3.5 9.75Z" clip-rule="evenodd" />
  </svg>`};Z.registerHelper("isPassed",function(e){return e.result==="pass"});Z.registerHelper("isFailed",function(e){return e.result==="fail"||e.result==="error"||e.result==="warn"});Z.registerHelper("isOthered",function(e){return!(e.result==="pass"||e.result==="fail"||e.result==="error"||e.result==="warn")});Z.registerHelper("renderName",function(e){let r=bt[e.result],t="text-blue-700";switch(e.result){case"pass":t="text-green-700";break;case"fail":t="text-red-700";break;case"error":t="text-red-700";break;case"warn":t="text-yellow-700";break}return`<div class="flex flex-row gap-2 ${t} items-center"><div>${r}</div><div class="">${e.name}</div></div>`});var Tt=ht.readFileSync(yt.resolve(w,"../resources/testrun.hbs"),"utf8"),St=Z.compile(Tt);function Ue(e){return St({res:e,testCount:e.passCount+e.failCount+e.errorCount+e.warnCount+e.skipCount})}import Ct from"axios";async function he(e,r){let t={...f(),projectId:r.projectId,runType:e,specs:[]};console.log(p.blueBright(`\u{1F680} Starting test run (id:${t.executionId})`));try{let s=q(r.cacheDir);switch(r.screenshots&&V.mkdir(`${r.screenshotsDir}/${t.executionId}`,{recursive:!0}),e){case"local":await It(t,r,s);break;case"remote":await $t(t,r,s);break}let n=J(t,t.specs),i=null;switch(n.result){case"pass":case"skip":i=p.greenBright;break;case"warn":i=p.yellowBright;break;case"fail":case"error":i=p.redBright;break}return await V.writeFile(`${r.logsDir}/${Pe(t.startDate,"yyyyMMddHHmmss")}_${t.executionId}.json`,JSON.stringify(t,null,2)),await V.writeFile(`${r.logsDir}/${Pe(t.startDate,"yyyyMMddHHmmss")}_${t.executionId}.html`,Ue(t)),await ke(r,t),console.log(i(`\u{1F4A5} Test run complete: ${n.result}`)),console.log(i(`  ${W(n.passCount)} passed`)),console.log(i(`  ${W(n.failCount)} failed`)),console.log(i(`  ${W(n.skipCount)} skipped`)),console.log(i(`  ${W(n.warnCount)} warnings`)),console.log(i(`  ${W(n.errorCount)} errors`)),n}catch(s){throw console.log(p.redBright(`\u{1F915} Exception running tests: ${s}`)),s}finally{Y()}}async function It(e,r,t){let s=await Q(r);await de(s,r,t);for(let n of s){let i=await xt(n,r,t,e.executionId);e.specs.push(i)}}async function $t(e,r,t){try{r.taskId&&(e.taskId=r.taskId);let{status:s,data:n}=await Ct.get(`${r.apiBaseURL}/projects/${r.projectId}/scripts`,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${r.apiKey}`}});if(s!==200)throw`Server returned ${s}`;for(let i of n){if(r.testScriptDataId&&i.scriptData.id!==r.testScriptDataId)continue;let o=await At(i,r,t,e.executionId);e.specs.push(o)}}catch(s){throw console.log(p.redBright(`\u{1F915} Running scripts for project ${r.projectId}: ${s}`)),s}}async function xt(e,r,t,s){console.log(p.blueBright(`Running ${e}`));let n=await ge(r);try{let i=await V.readFile(e,{encoding:"utf-8"}),o=Dt("sha256").update(i).digest("base64"),l=await Te(o,t);if(!l)throw"Script not found";let a=await Se(l.id,t);if(!a)throw"Test spec not found";if(a.definitions.length===0)throw"No tests found";a.name&&(console.log(p.whiteBright(a.name)),console.log(p.whiteBright("=".repeat(a.name.length))));let m={...f(a.name),specId:a.id,tests:[]};for(let y of a.definitions)if(!r.test||y.name===r.test){let re=await Ke(y,r,t,n,s);m.tests.push(re)}return J(m,m.tests)}catch(i){throw console.log(p.redBright(`\u{1F915} Processing ${e}: ${i}`)),i}finally{try{console.info(p.blueBright("\u{1F44D} Closing browser")),await we()}catch(i){console.warn(p.yellow(`\u{1F915} Closing browser: ${i}`))}}}async function At(e,r,t,s){let n=e.scriptData.spec;if(!n)throw"No spec found";console.log(p.blueBright(`Running ${n.name} (${n.id})`));let i=await ge(r);try{let o={...f(n.name),specId:n.id,tests:[]};for(let l of n.definitions)if(!r.test||l.name===r.test){let a=await Ke(l,r,t,i,s);o.tests.push(a)}return J(o,o.tests)}catch(o){throw console.log(p.redBright(`\u{1F915} Processing ${n.name} (${n.id}): ${o}`)),o}finally{try{console.info(p.blueBright("\u{1F44D} Closing browser")),await we()}catch(o){console.warn(p.yellow(`\u{1F915} Closing browser: ${o}`))}}}async function Ke(e,r,t,s,n){console.log(p.whiteBright(`  ${e.name}`)),console.log(p.whiteBright(`  ${"=".repeat(e.name.length)}`));let i={...f(e.name),definitionId:e.id,steps:[]},o=new Map;for(let a of e.calls)o.has(a.testSpecClauseId)||o.set(a.testSpecClauseId,[]),o.get(a.testSpecClauseId)?.push(a);let l={testRunId:n,scriptsDir:r.scriptsDir,browser:s,metadata:{},timeout:1e4};for(let a of e.steps){if(console.log(p.whiteBright(`  * ${a.clause} (L${a.line+1})`)),!o.has(a.id)){console.log(p.redBright(`    (\u2717) No function calls for ${a.clause}`));let y={...f(a.clause),stepId:a.id};i.steps.push(c(y,"error","no matching calls found for step"));continue}let m=o.get(a.id);if(!m||m.length==0){let y={...f(a.clause),stepId:a.id};i.steps.push(c(y,"error","no function calls found for step"));continue}l.currentStep=a;for(let y of m){let re=Ne(y.call);try{let se=JSON.parse(y.params),x=await re(l,se);if(i.steps.push(x),r.screenshots){x.screenshot=`${r.screenshotsDir}/${n}/${a.id}_${x.executionId}.png`;let ne=await s.takeScreenshot();await V.writeFile(x.screenshot,ne,"base64")}x.result==="pass"?console.log(p.greenBright("    (\u2713) Passed")):x.result==="warn"?console.log(p.yellowBright(`    (\u26A0) Warning: ${x.message}`)):console.log(p.redBright(`    (\u2717) Failed: ${x.message}`))}catch(se){console.log(p.redBright(`    (\u2717) Error: ${se}`));let x=await s.manage().logs().get(vt.Type.BROWSER);for(let ne of x)console.log(p.yellowBright(`    (\u2717) ${ne.message}`))}}}return J(i,i.steps)}async function ze(e){throw new Error("WebUI: not implemented (yet)")}import Me from"axios";import Bt from"inquirer";import{promises as te}from"fs";import We from"chalk";async function He(e){let r=[{type:"input",name:"projectId",message:"Project ID (copied from dashboard)",default:e.projectId},{type:"input",name:"apiKey",message:"Project API key (copied from dashboard)",default:e.apiKey}],t=await Bt.prompt(r);if(!t.projectId||!t.apiKey)throw new Error("Project ID and API key are required");e.projectId=t.projectId,e.apiKey=t.apiKey;try{let{data:s}=await Me.post(`${e.apiBaseURL}/projects/${e.projectId}/ping`,void 0,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${e.apiKey}`}});if(s!=="pong")throw new Error("Project ID or API key is invalid");let n=`TESTABULOUS_PROJECT_ID=${e.projectId}
TESTABULOUS_API_KEY=${e.apiKey}
`;await te.writeFile(".env.testabulous",n,{encoding:"utf-8"});let i=JSON.stringify({envFile:".env.testabulous"},null,2);await te.writeFile("testabulous.config.json",i,{encoding:"utf-8"});let o=await te.readFile("package.json",{encoding:"utf-8"}),l=JSON.parse(o);l.scripts||(l.scripts={}),l.scripts["testabulous:cache"]||(l.scripts["test:cache"]="testabulous cache --force"),l.scripts["testabulous:test"]||(l.scripts.test="testabulous test"),l.scripts["testabulous:help"]||(l.scripts["test:help"]="testabulous --help"),await te.writeFile("package.json",JSON.stringify(l,null,2),{encoding:"utf-8"}),console.log(We.greenBright(`Your project ID and API key have been saved to .env.testabulous and this file referenced in testabulous.config.json. You should make sure that .env.testabulous is added to your .gitignore file. Alternatively, you can merge the TESTABULOUS_PROJECT_ID and TESTABULOUS_API_KEY environment variables into another .env file and update the config file accordingly, or set them elsewhere.
You can now start creating your test files in ./testabulous/tests and call 'npm run test' to run your tests. See https://docs.testabulous.com/category/getting-started for more information.`))}catch(s){throw console.log(s),Me.isAxiosError(s)&&s.response&&(s.response.status===404||s.response.status===401)?new Error("Project ID or API key is invalid"):s}console.log(We.greenBright("\u{1F44D} Project initialised"))}console.log($.greenBright(Rt.textSync("Testabulous")));var S=new Et;S.exitOverride(e=>{console.log($.redBright(`\u{1F915} ${e}`)),process.exit(-1)});S.version("1.0.0").description("Testabulous E2E Testing Framework").option("-c, --config-file <value>","Local config file [./testabulous.config.json]").option("-e, --env-file <value>","File to load environment variables from").option("-p, --project-id <value>","Project ID").option("-k, --api-key <value>","API key").option("-r, --root-dir <value>","Test root directory [./testabulous]");S.command("init").description("Initialise testabulous project").action(async()=>{try{let e=await z(S.opts(),{});await P(e.cacheDir),await He(e)}catch(e){console.log($.redBright(`\u{1F915} Initialisation failed: ${e}`)),process.exit(-1)}});S.command("cache").option("-f, --file <value>","Specific test file to cache").option("-F, --force","Force re-cache of all test files").description("Parse and cache test files").action(async e=>{try{let r;try{r=await z(S.opts(),e),await P(r.cacheDir)}catch(t){console.log($.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}await xe(r)}catch(r){console.log($.redBright(`\u{1F915} ${r}`)),process.exit(-1)}});S.command("test").option("-f, --file <value>","Specific test file to execute").option("-t, --test <value>","Specific test to execute").description("Start testabulous test runner").action(async e=>{let r;try{r=await z(S.opts(),e),await P(r.cacheDir)}catch(t){console.log($.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}he("local",r).then(t=>{switch(t.result){case"pass":case"skip":process.exit(0);break;case"warn":process.exit(1);break;case"fail":process.exit(2);break;case"error":process.exit(3);break}}).catch(()=>{process.exit(3)})});S.command("remote").description("Start testabulous test runner for remote run").action(async e=>{let r;try{r=await z(S.opts(),e),await P(r.cacheDir)}catch(t){console.log($.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}he("remote",r).then(t=>{switch(t.result){case"pass":case"skip":process.exit(0);break;case"warn":process.exit(1);break;case"fail":process.exit(2);break;case"error":process.exit(3);break}}).catch(()=>{process.exit(3)})});S.command("open").description("Open testabulous UI").option("-P, --port <value>","Port to run Testabulous UI [4001]").action(async e=>{let r;try{r=await z(S.opts(),e),await P(r.cacheDir)}catch(t){console.log($.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}ze(r).then(()=>{console.log($.greenBright("Lingobt UI terminated"))}).catch(t=>{console.log($.redBright(`\u{1F915} ${t}`)),process.exit(-1)})});try{S.parse(process.argv)}catch(e){console.log($.redBright(`\u{1F915} ${e}`)),process.exit(-1)}
