#!/usr/bin/env node
var We=Object.defineProperty;var He=(e,r)=>{for(var t in r)We(e,t,{get:r[t],enumerable:!0})};import{fileURLToPath as qe}from"url";import Je from"path";var Ze=()=>qe(import.meta.url),Ve=()=>Je.dirname(Ze()),g=Ve();import C from"chalk";import Bt from"figlet";import{Command as Rt}from"commander";import Z from"fs/promises";import p from"chalk";import{createHash as St}from"node:crypto";import{eq as x,and as ae}from"drizzle-orm";import{drizzle as Ge}from"drizzle-orm/better-sqlite3";import{migrate as Qe}from"drizzle-orm/better-sqlite3/migrator";import Xe from"better-sqlite3";import be from"path";var oe={};He(oe,{callsTable:()=>j,clausesTable:()=>d,definitionsTable:()=>S,scriptDataTable:()=>A,scriptsTable:()=>N,testSpecsTable:()=>$});import{text as c,integer as R,sqliteTable as O,index as Ye}from"drizzle-orm/sqlite-core";var N=O("scripts",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),name:c("name").notNull(),uri:c("uri").notNull(),scriptType:c("script_type").notNull()}),A=O("script_data",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),hash:c("hash").notNull()},e=>({hashIdx:Ye("hash_idx").on(e.hash)})),$=O("test_specs",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),scriptDataId:c("script_data_id").notNull(),name:c("name").notNull(),description:c("description")}),S=O("definitions",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),testSpecId:c("test_spec_id").notNull(),name:c("name").notNull(),line:R("line").notNull()}),d=O("clauses",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),parentId:c("parent_id").notNull(),type:R("type").notNull(),line:R("line").notNull(),clause:c("clause").notNull()}),j=O("calls",{id:c("id").notNull().primaryKey(),createdAt:c("created_at").notNull(),updatedAt:c("updated_at"),status:R("status").notNull(),testSpecDefinitionId:c("test_spec_definition_id").notNull(),testSpecClauseId:c("test_spec_clause_id").notNull(),externalId:c("external_id"),call:c("call").notNull(),params:c("params").notNull()});import le from"chalk";var L=null,M=null,W=e=>(M===null&&(L===null&&(L=new Xe(be.join(e,"testabulous.db"))),M=Ge(L,{schema:oe,logger:!1})),M),V=()=>{console.log(le.yellow("\u{1F44D} Closing database")),M!=null&&(M=null),L!=null&&(L.close(),L=null)},U=async e=>{let r=W(e);try{let t=be.join(g,"..","drizzle");console.log(le.greenBright(`Migrating databases from: ${t}`)),await Qe(r,{migrationsFolder:t})}catch(t){console.log(le.redBright(`\u{1F915} Migrating database: ${t}`))}};async function Y(e,r){let t=await r.select().from(A).where(x(A.hash,e));return t.length===0?null:t[0]}async function ye(e,r){let t=await r.select().from($).where(x($.scriptDataId,e));if(t.length===0)return null;let s=t[0],n=await r.select().from(d).where(ae(x(d.parentId,s.id),x(d.type,1))).orderBy(d.line);s.givens=n;let i=await r.select().from(S).where(x(S.testSpecId,s.id)).orderBy(S.line);s.definitions=i;for(let o of s.definitions){let l=await r.select().from(d).where(ae(x(d.parentId,o.id),x(d.type,2))).orderBy(d.line);o.givens=l;let a=await r.select().from(d).where(ae(x(d.parentId,o.id),x(d.type,0))).orderBy(d.line);o.steps=a;let m=await r.select().from(j).where(x(j.testSpecDefinitionId,o.id));o.calls=m}return s}import tt from"fs/promises";import _ from"chalk";import{eq as k,inArray as ve}from"drizzle-orm";import{createHash as rt}from"node:crypto";import ce from"axios";import Te from"fs/promises";import et from"path";import Se from"chalk";async function G(e){let r=[];if(e.file?r.push(e.file):(console.log(Se.blueBright(`\u23F3 Looking for test files in ${e.testsDir}`)),r=await De(e.testsDir),console.log(Se.blueBright(`\u{1F44D} Found ${r.length} test files`))),r.length===0)throw"No test files found";return r}async function De(e){let r=await Te.readdir(e),t=[];for(let s of r){let n=et.join(e,s);if((await Te.stat(n)).isDirectory()){let o=await De(n);t.push(...o)}else n.toLocaleLowerCase().endsWith(".md")&&t.push(n)}return t}async function Ce(e){try{let r=await G(e),t=W(e.cacheDir);await ue(r,e,t)}catch(r){console.log(_.redBright(`\u{1F915} Caching files failed: ${r}`))}finally{V()}}async function ue(e,r,t){for(let s of e)await st(s,r,t)}async function st(e,r,t){console.log(_.blueBright(`Processing ${e}`)),r.force&&console.log(_.blueBright(`Forcing re-cache of ${e}`));try{let s=await tt.readFile(e,{encoding:"utf-8"}),n={uri:`file://${e}`,data:s,scriptType:"markdown",forceParse:r.force},i=rt("sha256").update(s).digest("base64"),o=await Y(i,t);if(!r.force&&o&&o.status===1){console.log(_.greenBright(`\u{1F44D} ${e} already cached`));return}let{data:l}=await ce.post(`${r.apiBaseURL}/projects/${r.projectId}/scripts`,n,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${r.apiKey}`}});await Ie(l,t),l.scriptData.status===0&&await nt(l.id,l.scriptData.id,r,t),console.log(_.greenBright(`\u{1F44D} ${e} cached`))}catch(s){throw ce.isAxiosError(s)&&s.response&&s.response.status===402?"You have insufficient credits, please top up your account":(console.log(_.redBright(`\u{1F915} Processing ${e}: ${s}`)),s)}}async function nt(e,r,t,s){return console.log(_.blueBright(`Polling for active script ${e}`)),new Promise((n,i)=>{let o=new Date,l=setInterval(async()=>{try{let{status:a,data:m}=await ce.get(`${t.apiBaseURL}/projects/${t.projectId}/scripts/${e}/data/${r}`,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${t.apiKey}`}});if(a!==200)throw`Server returned ${a}`;if(await Ie(m,s),m.scriptData.status===1){console.log(_.greenBright(`\u{1F44D} ${m.id} cached`)),clearTimeout(l),n(m);return}new Date().getTime()-o.getTime()>6e4&&(clearTimeout(l),i(`Timeout waiting for active script ${e}`))}catch(a){throw console.log(_.redBright(`\u{1F915} Polling for active script ${e}: ${a}`)),a}},5e3)})}async function Ie(e,r){await r.transaction(async t=>{if((await t.select().from(N).where(k(N.id,e.id))).length===0?await t.insert(N).values({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,status:e.status,name:e.name,uri:e.uri,scriptType:e.scriptType}):await t.update(N).set({updatedAt:e.updatedAt,status:e.status,name:e.name}).where(k(N.id,e.id)),(await t.select().from(A).where(k(A.id,e.scriptData.id))).length===0?await t.insert(A).values({id:e.scriptData.id,createdAt:e.scriptData.createdAt,updatedAt:e.scriptData.updatedAt,status:e.scriptData.status,hash:e.scriptData.hash}):await t.update(A).set({updatedAt:e.scriptData.updatedAt,status:e.scriptData.status}).where(k(A.id,e.scriptData.id)),e.scriptData.spec){(await t.select().from($).where(k($.id,e.scriptData.spec.id))).length===0?await t.insert($).values({id:e.scriptData.spec.id,createdAt:e.scriptData.spec.createdAt,updatedAt:e.scriptData.spec.updatedAt,status:e.scriptData.spec.status,scriptDataId:e.scriptData.id,name:e.scriptData.spec.name,description:e.scriptData.spec.description}):await t.update($).set({updatedAt:e.scriptData.spec.updatedAt,status:e.scriptData.spec.status,name:e.scriptData.spec.name,description:e.scriptData.spec.description}).where(k($.id,e.scriptData.spec.id));let o=t.select({data:S.id}).from(S).where(k(S.testSpecId,e.scriptData.spec.id));if(await t.delete(d).where(ve(d.parentId,o)),await t.delete(j).where(ve(j.testSpecDefinitionId,o)),await t.delete(S).where(k(S.testSpecId,e.scriptData.spec.id)),await t.delete(d).where(k(d.parentId,e.scriptData.spec.id)),e.scriptData.spec.givens)for(let l of e.scriptData.spec.givens)await t.insert(d).values({id:l.id,createdAt:l.createdAt,updatedAt:l.updatedAt,status:l.status,parentId:e.scriptData.spec.id,type:l.type,line:l.line,clause:l.clause});for(let l of e.scriptData.spec.definitions){if(await t.insert(S).values({id:l.id,createdAt:l.createdAt,updatedAt:l.updatedAt,status:l.status,testSpecId:l.testSpecId,name:l.name,line:l.line}),l.givens)for(let a of l.givens)await t.insert(d).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,parentId:l.id,type:a.type,line:a.line,clause:a.clause});if(l.steps)for(let a of l.steps)await t.insert(d).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,parentId:l.id,type:a.type,line:a.line,clause:a.clause});for(let a of l.calls)await t.insert(j).values({id:a.id,createdAt:a.createdAt,updatedAt:a.updatedAt,status:a.status,testSpecDefinitionId:a.testSpecDefinitionId,testSpecClauseId:a.testSpecClauseId,externalId:a.externalId,call:a.call,params:a.params})}}})}import{setInterval as _e}from"timers/promises";import mt from"path";import v from"chalk";import{setInterval as xe}from"timers/promises";import{By as B}from"selenium-webdriver";import{error as Ae}from"selenium-webdriver";import{createId as it}from"@paralleldrive/cuid2";import{format as ot}from"date-fns";import at from"axios";import lt from"chalk";var ct="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",$e=new Map([["l","abcdefghijklmnopqrstuvwxyz"],["L","ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["n","0123456789"],["s","!@#$%^&*()_+"]]);function ut(e){let r="",t="";for(let o of e){if(/\d/.test(o)){r+=o;continue}$e.has(o)&&(t+=$e.get(o))}let s=8;r>""&&(s=parseInt(r));let n=t;t===""&&(n=ct);let i="";for(let o=0;o<s;o++)i+=n.charAt(Math.floor(Math.random()*n.length));return i}var pe=new Map;pe.set("_random",ut);function Q(e,r){let t=r,s=r.match(/\{\{.+?\}\}/g);if(s)for(let n of s){let i=n.substring(2,n.length-2).substring(0,n.length-2).trim();if(e.metadata[i]){t=t.replace(n,e.metadata[i]);continue}if(/^['"“”].*['"“”]$/.test(i)){t=i.substring(1,i.length-1);continue}if(/_\w+\(.*?\)/.test(i)){let o=i.split(/[()]/).filter(l=>l.length>0);if(pe.has(o[0])){let l=pe.get(o[0]);if(o.length>1){t=t.replace(n,l(o[1]));continue}t=t.replace(n,l())}}}return t}async function P(e,r){return new Promise((t,s)=>{(async()=>{let n=null;for await(let i of xe(250,new Date().valueOf())){if(new Date().valueOf()-i>r){if(n){t(n);return}s(new Error("time out executing step"));return}let l=await e();if(l){if(l.result==="pass"){t(l);return}n=l}}})()})}async function H(e,r,t,s){return new Promise((n,i)=>{(async()=>{for await(let o of xe(100,new Date().valueOf())){if(new Date().valueOf()-o>s){i(new Error(`time out search for element: ${r}=${t}`));break}let a=null,m=r.toLowerCase();/^aria[- _]/.test(m)&&(m="aria");try{switch(m){case"id":a=await e.browser.findElement(B.id(t));break;case"class":a=await e.browser.findElement(B.className(t));break;case"css selector":case"css":a=await e.browser.findElement(B.css(t));break;case"field":a=await e.browser.findElement(B.name(t));break;case"label":a=await pt(e,r,t);break;case"name":a=await e.browser.findElement(B.css(`*[name='${t}']`));break;case"text":a=await e.browser.findElement(B.xpath(`//*[text()='${t}']`));break;case"button":a=await e.browser.findElement(B.xpath(`//button[text()='${t}']`));break;case"aria":a=await e.browser.findElement(B.css(`*[${r.toLowerCase().replaceAll(/[ _]/g,"-")}='${t}']`));break;default:throw new Error(`unknown identifier type: ${r}`)}}catch(b){if(b instanceof Ae.NoSuchElementError||b instanceof Ae.StaleElementReferenceError)continue;i(b);return}a&&n(a)}})()})}async function pt(e,r,t){let s=await e.browser.findElement(B.xpath(`//*[contains(text(),'${t}')]`));if(!s)return null;let n=await s.getAttribute("for");return n?await e.browser.findElement(B.id(n)):s}async function Be(e,r){let t=await e.getAttribute("class");return t?t.toString().split(" ").indexOf(r)>=0:!1}function K(e){let r=e.toString();for(;r.length<5;)r=" "+r;return r}function f(e){let r=new Date;return{executionId:it(),name:e||`Test run: ${ot(r,"yyyy-MM-dd HH:mm:ss")}`,result:"fail",startDate:r,duration:0,passCount:0,failCount:0,skipCount:0,warnCount:0,errorCount:0}}function u(e,r,t){switch(e.result=r,r){case"pass":e.passCount++;break;case"fail":e.failCount++;break;case"skip":e.skipCount++;break;case"warn":e.warnCount++;break;case"error":e.errorCount++;break}return e.message=t,e.endDate=new Date,e.duration=e.endDate.getTime()-e.startDate.getTime(),e}function q(e,r){e.endDate=new Date,e.duration=e.endDate.getTime()-e.startDate.getTime();for(let t of r)e.passCount+=t.passCount,e.failCount+=t.failCount,e.skipCount+=t.skipCount,e.warnCount+=t.warnCount,e.errorCount+=t.errorCount;return e.errorCount>0?e.result="error":e.failCount>0?e.result="fail":e.passCount==0&&e.warnCount>0?e.result="warn":e.passCount==0&&e.skipCount>0?e.result="skip":e.result="pass",e}async function Re(e,r){if(!e.uploadResults)return;let{status:t}=await at.post(`${e.apiBaseURL}/projects/${e.projectId}/results`,r,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${e.apiKey}`}});if(t!==200)throw`Server returned ${t}`;console.log(lt.yellow("\u{1F44D} Uploaded results to Testabulous"))}import E from"fs/promises";import D from"path";import X from"chalk";import de from"untildify";import{z as h}from"zod";var fe=h.enum(["chrome","MicrosoftEdge","firefox","internet explorer","safari"]),ke=h.object({projectId:h.string().optional(),apiKey:h.string().optional(),baseDir:h.string().optional().default("testabulous"),uiPort:h.number().optional().default(4e3),apiBaseURL:h.string().url().optional().default("https://testabulous.com/api/v1"),screenshots:h.boolean().optional().default(!1),uploadResults:h.boolean().optional().default(!1),browser:h.object({browser:fe.optional().default("chrome"),headless:h.boolean().optional().default(!1),windowSize:h.object({width:h.number().optional().default(1920),height:h.number().optional().default(1080)}).optional()}).optional().default({browser:"chrome",headless:!0,windowSize:{width:1920,height:1080}}),envFile:h.string().optional()}),dt={rootDir:process.cwd(),baseDir:"testabulous",testsDir:"./tests",cacheDir:"./cache",logsDir:"./logs",scriptsDir:"./scripts",screenshotsDir:"./screenshots",force:!1,debug:!1};async function z(e,r){let t={...dt,...ke.parse({}),...r};if(e.rootDir&&e.configFile)throw new Error("Cannot specify both --root-dir and --config-file");let s=t.rootDir,n="testabulous.config.json";if(e.rootDir?(s=de(e.rootDir),n=D.join(s,"testabulous.config.json")):e.configFile&&(s=D.resolve(process.cwd(),D.dirname(de(e.configFile))),n=D.resolve(process.cwd(),de(e.configFile))),t.rootDir=D.isAbsolute(s)?s:D.resolve(process.cwd(),s),console.log(X.greenBright(`Using root directory ${t.rootDir}`)),await ee(n))try{let o=await E.readFile(n,{encoding:"utf-8"}),l=ke.parse(JSON.parse(o));t={...t,...l},console.log(X.greenBright(`\u{1F680} Loaded config file ${n}`))}catch(o){throw`Config file ${e.configFile} is not parsable: ${o}`}else console.log(X.yellow("\u{1F915} Configuration file not found, using defaults"));if(e.envFile&&(t.envFile=e.envFile),t.envFile)if(t.envFile=D.resolve(t.rootDir,t.envFile),await ee(t.envFile))await ft(t.envFile),console.log(X.greenBright(`\u{1F680} Loaded environment file ${t.envFile}`));else throw new Error(`\u{1F915} Environment file ${t.envFile} not found`);if(t.apiBaseURL=process.env.TESTABULOUS_API_BASE_URL||t.apiBaseURL,t.projectId=process.env.TESTABULOUS_PROJECT_ID||t.projectId,t.taskId=process.env.TESTABULOUS_TASK_ID,t.apiKey=process.env.TESTABULOUS_API_KEY||t.apiKey,t.testScriptDataId=process.env.TESTABULOUS_TEST_SCRIPT_DATA_ID,process.env.TESTABULOUS_UPLOAD_RESULTS&&(t.uploadResults=(process.env.TESTABULOUS_UPLOAD_RESULTS||"false").toLowerCase()==="true"),e.projectId&&(t.projectId=e.projectId),e.apiKey&&(t.apiKey=e.apiKey),e.port&&(t.uiPort=e.port),t.projectId==="")throw"A Project ID is required";if(t.apiKey==="")throw"An API key is required";return t.testsDir=D.resolve(t.rootDir,t.baseDir,t.testsDir),t.cacheDir=D.resolve(t.rootDir,t.baseDir,t.cacheDir),t.logsDir=D.resolve(t.rootDir,t.baseDir,t.logsDir),t.scriptsDir=D.resolve(t.rootDir,t.baseDir,t.scriptsDir),t.screenshotsDir=D.resolve(t.rootDir,t.baseDir,t.screenshotsDir),await E.mkdir(t.rootDir,{recursive:!0}),await E.mkdir(t.testsDir,{recursive:!0}),await E.mkdir(t.cacheDir,{recursive:!0}),await E.mkdir(t.logsDir,{recursive:!0}),await E.mkdir(t.scriptsDir,{recursive:!0}),await E.mkdir(t.screenshotsDir,{recursive:!0}),t}async function ft(e){try{(await E.readFile(e,{encoding:"utf-8"})).split(`
`).forEach(t=>{if(t=t.trim(),t.length===0||t.startsWith("#")||t.startsWith("//"))return;let s=t.indexOf("#");s>-1&&(t=t.substring(0,s).trim());let[n,i]=t.split("=");if(n&&i)process.env[n]=i;else throw new Error(`\u{1F915} Could not parse environment file ${e}: malformed (${t})`)})}catch{throw new Error(`\u{1F915} Could not parse environment file ${e}`)}}async function ee(e){return E.stat(e).then(()=>!0).catch(()=>!1)}var w=new Map;function Ee(e){if(!w.has(e))throw new Error(`test runner call not found: ${e}`);return w.get(e)}var je=new Set;je.add("title");w.set("navigate_to_page",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.url)throw new Error("missing argument: url");try{e.browser.getCurrentUrl()===r.url?await e.browser.navigate().refresh():await e.browser.get(r.url);for await(let n of _e(1e3,new Date().valueOf())){if(new Date().valueOf()-n>e.timeout)throw new Error("time out waiting for navigation");let o=await e.browser.executeScript("return document.readyState");if(o==="complete"||o==="interactive")break}await e.browser.executeScript(`window.TESTABULOUS_testRunId = "${e.testRunId}"`),u(t,"pass")}catch(s){console.log(v.redBright(`\u{1F915} ${s}`)),u(t,"error",s.toString())}return t});w.set("check_for_page_to_have_attribute",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.value)throw new Error("missing argument: value");let t=r.identifier.toString().toLowerCase();if(!je.has(t))throw new Error(`unsupported identifier: ${t}`);return await P(async()=>{let n={...f(e.currentStep.clause),stepId:e.currentStep.id};try{if(await e.browser.executeScript(`return document.${t}`)==="loading")return;let o=await e.browser.executeScript(`return document.${t}`);return o==r.value?u(n,"pass"):u(n,"fail",`found='${o}', expected='${r.value}'`),n.endDate=new Date,n.duration=n.endDate.valueOf()-n.startDate.valueOf(),n}catch(i){console.log(v.redBright(`\u{1F915} ${i}`)),n.result="error",n.message=i.toString()}},e.timeout)});w.set("click_on_element",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");return await P(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await H(e,r.identifierType,r.identifier,e.timeout);return n?(await n.click(),u(s,"pass"),s):(u(s,"error","element not found"),s)}catch(n){console.log(v.redBright(`\u{1F915} ${n}`)),u(s,"error",n.toString())}},e.timeout)});w.set("enter_text_in_element",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");return await P(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await H(e,r.identifierType,r.identifier,e.timeout);return n?(await n.sendKeys(Q(e,r.data)),u(s,"pass"),s):void 0}catch(n){console.log(v.redBright(`\u{1F915} ${n}`)),u(s,"error",n.toString())}},e.timeout)});async function Fe(e,r,t){if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");if(!r.state)throw new Error("missing argument: state");if(!r.stateType)throw new Error("missing argument: stateType");return await P(async()=>{let n={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let i=await H(e,r.identifierType,r.identifier,e.timeout);if(!i)return;let o=!1;switch(r.stateType){case"class":o=await Be(i,r.state);break;default:throw new Error("unknown state type")}return o===t?u(n,"pass"):u(n,"fail",`unexpected state: found='${o}', expected='${t}'`),n}catch(i){console.log(v.redBright(`\u{1F915} ${i}`)),u(n,"error",i.toString())}},e.timeout)}w.set("element_has_property_or_state",async(e,r)=>Fe(e,r,!0));w.set("element_does_not_have_property_or_state",async(e,r)=>Fe(e,r,!1));w.set("element_has_text",async(e,r)=>{if(!r.identifier)throw new Error("missing argument: identifier");if(!r.identifierType)throw new Error("missing argument: identifierType");if(!r.text)throw new Error("missing argument: text");return await P(async()=>{let s={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let n=await H(e,r.identifierType,r.identifier,e.timeout);if(!n)return;let i=await n.getText();return i===r.text?u(s,"pass"):u(s,"fail",`invalid text: found='${i}', expected='${r.text}'`),s}catch(n){console.log(v.redBright(`\u{1F915} ${n}`)),u(s,"error",n.toString())}},e.timeout)});w.set("wait_for_time_period",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let s=parseInt(r.time);switch(r.unit){case"s":case"second":case"seconds":s=s*1e3;break;case"m":case"minute":case"minutes":s=s*1e3*60;break;case"h":case"hour":case"hours":s=s*1e3*60*60;break;default:throw new Error(`unsupported time unit: ${r.unit}`)}await new Promise(n=>setTimeout(n,s)),u(t,"pass")}catch(s){console.log(v.redBright(`\u{1F915} ${s}`)),u(t,"error",s.toString())}return t});w.set("store_value_in_variable",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.variableName)throw new Error("missing argument: variableName");try{e.metadata[r.variableName]=Q(e,r.value),u(t,"pass")}catch(s){console.log(v.redBright(`\u{1F915} ${s}`)),u(t,"error",s.toString())}return t});w.set("check_url_path",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};try{let s=await e.browser.getCurrentUrl(),n=new URL(s);n.pathname===r.path?u(t,"pass"):u(t,"fail",`invalid url path: found='${n.pathname}', expected='${r.path}'`)}catch(s){console.log(v.redBright(`\u{1F915} ${s}`)),u(t,"error",s.toString())}return t});w.set("wait_for_element_to_have_value",async e=>{let r={...f(e.currentStep.clause),stepId:e.currentStep.id};return u(r,"error","not implemented"),r});w.set("load_value_from_environment_variable",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.variableName)throw new Error("missing argument: variableName");if(!r.envVarName)throw new Error("missing argument: envVariableName");try{let s=r.envVarName.startsWith("$")?r.envVarName.slice(1):r.envVarName,n=process.env[s]||"";e.metadata[r.variableName]=Q(e,n),u(t,"pass")}catch(s){console.log(v.redBright(`\u{1F915} ${s}`)),u(t,"error",s.toString())}return t});w.set("execute_script",async(e,r)=>{let t={...f(e.currentStep.clause),stepId:e.currentStep.id};if(!r.scriptName)throw new Error("missing argument: variableName");let s=mt.join(e.scriptsDir,r.scriptName);if(!ee(s))throw new Error(`missing script: ${s}`);try{let{default:n}=await import(s),i=await n(e);u(t,i.result,i.message)}catch(n){console.log(v.redBright(`\u{1F915} ${n}`)),u(t,"error",n.toString())}return t});w.set("wait_for_navigation",async e=>{let r={...f(e.currentStep.clause),stepId:e.currentStep.id};try{for await(let t of _e(1e3,new Date().valueOf())){if(new Date().valueOf()-t>e.timeout)return u(r,"fail","timed out waiting for navigation"),r;let n=await e.browser.executeScript("return document.readyState");if(!(n==="complete"||n==="interactive"))continue;if(!await e.browser.executeScript("return window.TESTABULOUS_testRunId"))break}await e.browser.executeScript(`window.TESTABULOUS_testRunId = "${e.testRunId}"`),u(r,"pass")}catch(t){console.log(v.redBright(`\u{1F915} ${t}`)),u(r,"error",t.toString())}return r});import"chromedriver";import{Builder as gt,logging as me}from"selenium-webdriver";import*as Ne from"selenium-webdriver/chrome.js";import te from"chalk";var F=null;async function ge(e){if(F)return F;console.log(te.greenBright("\u23F3 Starting web driver"));let r=e.browser?.browser??fe.Values.chrome,t={width:e.browser?.windowSize?.width??1920,height:e.browser?.windowSize?.height??1080},s=e.browser?.headless??!1,n=e.browser?.headless??!1,i=new me.Preferences;i.setLevel(me.Type.BROWSER,me.Level.ALL);let o=new Ne.Options;return s&&(o=o.addArguments("--headless=new")),n&&(o=o.addArguments("--disable-gpu")),o=o.addArguments("--no-sandbox"),o=o.addArguments("--disable-dev-shm-usage"),o=o.windowSize(t).setLoggingPrefs(i),console.log(te.blue(`Staring browser: ${F}`)),console.log(te.blue(`Screen size: ${t.width}x${t.height}`)),console.log(te.blue(`Headless: ${s}`)),F=new gt().forBrowser(r).setChromeOptions(o).build(),F}async function we(){F&&await F.quit(),F=null}import{logging as Dt}from"selenium-webdriver";import{format as Le}from"date-fns";import wt from"fs";import ht from"path";import J from"handlebars";var bt={pass:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
  </svg>`,fail:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z" />
  </svg>`,error:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M6.701 2.25c.577-1 2.02-1 2.598 0l5.196 9a1.5 1.5 0 0 1-1.299 2.25H2.804a1.5 1.5 0 0 1-1.3-2.25l5.197-9ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 1 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
  </svg>`,warn:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M6.701 2.25c.577-1 2.02-1 2.598 0l5.196 9a1.5 1.5 0 0 1-1.299 2.25H2.804a1.5 1.5 0 0 1-1.3-2.25l5.197-9ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 1 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
  </svg>`,skip:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
    <path fill-rule="evenodd" d="M3.5 9.75A2.75 2.75 0 0 1 6.25 7h5.19L9.22 9.22a.75.75 0 1 0 1.06 1.06l3.5-3.5a.75.75 0 0 0 0-1.06l-3.5-3.5a.75.75 0 1 0-1.06 1.06l2.22 2.22H6.25a4.25 4.25 0 0 0 0 8.5h1a.75.75 0 0 0 0-1.5h-1A2.75 2.75 0 0 1 3.5 9.75Z" clip-rule="evenodd" />
  </svg>`};J.registerHelper("isPassed",function(e){return e.result==="pass"});J.registerHelper("isFailed",function(e){return e.result==="fail"||e.result==="error"||e.result==="warn"});J.registerHelper("isOthered",function(e){return!(e.result==="pass"||e.result==="fail"||e.result==="error"||e.result==="warn")});J.registerHelper("renderName",function(e){let r=bt[e.result],t="text-blue-700";switch(e.result){case"pass":t="text-green-700";break;case"fail":t="text-red-700";break;case"error":t="text-red-700";break;case"warn":t="text-yellow-700";break}return`<div class="flex flex-row gap-2 ${t} items-center"><div>${r}</div><div class="">${e.name}</div></div>`});var yt=wt.readFileSync(ht.resolve(g,"../resources/testrun.hbs"),"utf8"),Tt=J.compile(yt);function Oe(e){return Tt({res:e,testCount:e.passCount+e.failCount+e.errorCount+e.warnCount+e.skipCount})}import vt from"axios";async function he(e,r){let t={...f(),projectId:r.projectId,runType:e,specs:[]};console.log(p.blueBright(`\u{1F680} Starting test run (id:${t.executionId})`));try{let s=W(r.cacheDir);switch(r.screenshots&&Z.mkdir(`${r.screenshotsDir}/${t.executionId}`,{recursive:!0}),e){case"local":await Ct(t,r,s);break;case"remote":await It(t,r,s);break}let n=q(t,t.specs),i=null;switch(n.result){case"pass":case"skip":i=p.greenBright;break;case"warn":i=p.yellowBright;break;case"fail":case"error":i=p.redBright;break}return await Z.writeFile(`${r.logsDir}/${Le(t.startDate,"yyyyMMddHHmmss")}_${t.executionId}.json`,JSON.stringify(t,null,2)),await Z.writeFile(`${r.logsDir}/${Le(t.startDate,"yyyyMMddHHmmss")}_${t.executionId}.html`,Oe(t)),await Re(r,t),console.log(i(`\u{1F4A5} Test run complete: ${n.result}`)),console.log(i(`  ${K(n.passCount)} passed`)),console.log(i(`  ${K(n.failCount)} failed`)),console.log(i(`  ${K(n.skipCount)} skipped`)),console.log(i(`  ${K(n.warnCount)} warnings`)),console.log(i(`  ${K(n.errorCount)} errors`)),n}catch(s){throw console.log(p.redBright(`\u{1F915} Exception running tests: ${s}`)),s}finally{V()}}async function Ct(e,r,t){let s=await G(r);await ue(s,r,t);for(let n of s){let i=await At(n,r,t,e.executionId);e.specs.push(i)}}async function It(e,r,t){try{r.taskId&&(e.taskId=r.taskId);let{status:s,data:n}=await vt.get(`${r.apiBaseURL}/projects/${r.projectId}/scripts`,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${r.apiKey}`}});if(s!==200)throw`Server returned ${s}`;for(let i of n){if(r.testScriptDataId&&i.scriptData.id!==r.testScriptDataId)continue;let o=await $t(i,r,t,e.executionId);e.specs.push(o)}}catch(s){throw console.log(p.redBright(`\u{1F915} Running scripts for project ${r.projectId}: ${s}`)),s}}async function At(e,r,t,s){console.log(p.blueBright(`Running ${e}`));let n=await ge(r);try{let i=await Z.readFile(e,{encoding:"utf-8"}),o=St("sha256").update(i).digest("base64"),l=await Y(o,t);if(!l)throw"Script not found";let a=await ye(l.id,t);if(!a)throw"Test spec not found";if(a.definitions.length===0)throw"No tests found";a.name&&(console.log(p.whiteBright(a.name)),console.log(p.whiteBright("=".repeat(a.name.length))));let m={...f(a.name),specId:a.id,tests:[]};for(let b of a.definitions)if(!r.test||b.name===r.test){let se=await Ue(b,r,t,n,s);m.tests.push(se)}return q(m,m.tests)}catch(i){throw console.log(p.redBright(`\u{1F915} Processing ${e}: ${i}`)),i}finally{try{console.info(p.blueBright("\u{1F44D} Closing browser")),await we()}catch(i){console.warn(p.yellow(`\u{1F915} Closing browser: ${i}`))}}}async function $t(e,r,t,s){let n=e.scriptData.spec;if(!n)throw"No spec found";console.log(p.blueBright(`Running ${n.name} (${n.id})`));let i=await ge(r);try{let o={...f(n.name),specId:n.id,tests:[]};for(let l of n.definitions)if(!r.test||l.name===r.test){let a=await Ue(l,r,t,i,s);o.tests.push(a)}return q(o,o.tests)}catch(o){throw console.log(p.redBright(`\u{1F915} Processing ${n.name} (${n.id}): ${o}`)),o}finally{try{console.info(p.blueBright("\u{1F44D} Closing browser")),await we()}catch(o){console.warn(p.yellow(`\u{1F915} Closing browser: ${o}`))}}}async function Ue(e,r,t,s,n){console.log(p.whiteBright(`  ${e.name}`)),console.log(p.whiteBright(`  ${"=".repeat(e.name.length)}`));let i={...f(e.name),definitionId:e.id,steps:[]},o=new Map;for(let a of e.calls)o.has(a.testSpecClauseId)||o.set(a.testSpecClauseId,[]),o.get(a.testSpecClauseId)?.push(a);let l={testRunId:n,scriptsDir:r.scriptsDir,browser:s,metadata:{},timeout:1e4};for(let a of e.steps){if(console.log(p.whiteBright(`  * ${a.clause} (L${a.line+1})`)),!o.has(a.id)){console.log(p.redBright(`    (\u2717) No function calls for ${a.clause}`));let b={...f(a.clause),stepId:a.id};i.steps.push(u(b,"error","no matching calls found for step"));continue}let m=o.get(a.id);if(!m||m.length==0){let b={...f(a.clause),stepId:a.id};i.steps.push(u(b,"error","no function calls found for step"));continue}l.currentStep=a;for(let b of m){let se=Ee(b.call);try{let ne=JSON.parse(b.params),I=await se(l,ne);if(i.steps.push(I),r.screenshots){I.screenshot=`${r.screenshotsDir}/${n}/${a.id}_${I.executionId}.png`;let ie=await s.takeScreenshot();await Z.writeFile(I.screenshot,ie,"base64")}I.result==="pass"?console.log(p.greenBright("    (\u2713) Passed")):I.result==="warn"?console.log(p.yellowBright(`    (\u26A0) Warning: ${I.message}`)):console.log(p.redBright(`    (\u2717) Failed: ${I.message}`))}catch(ne){console.log(p.redBright(`    (\u2717) Error: ${ne}`));let I=await s.manage().logs().get(Dt.Type.BROWSER);for(let ie of I)console.log(p.yellowBright(`    (\u2717) ${ie.message}`))}}}return q(i,i.steps)}async function Pe(e){throw new Error("WebUI: not implemented (yet)")}import Ke from"axios";import xt from"inquirer";import{promises as re}from"fs";import ze from"chalk";async function Me(e){let r=[{type:"input",name:"projectId",message:"Project ID (copied from dashboard)",default:e.projectId},{type:"input",name:"apiKey",message:"Project API key (copied from dashboard)",default:e.apiKey}],t=await xt.prompt(r);if(!t.projectId||!t.apiKey)throw new Error("Project ID and API key are required");e.projectId=t.projectId,e.apiKey=t.apiKey;try{let{data:s}=await Ke.post(`${e.apiBaseURL}/projects/${e.projectId}/ping`,void 0,{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${e.apiKey}`}});if(s!=="pong")throw new Error("Project ID or API key is invalid");let n=`TESTABULOUS_PROJECT_ID=${e.projectId}
TESTABULOUS_API_KEY=${e.apiKey}
`;await re.writeFile(".env.testabulous",n,{encoding:"utf-8"});let i=JSON.stringify({envFile:".env.testabulous"},null,2);await re.writeFile("testabulous.config.json",i,{encoding:"utf-8"});let o=await re.readFile("package.json",{encoding:"utf-8"}),l=JSON.parse(o);l.scripts||(l.scripts={}),l.scripts["testabulous:cache"]||(l.scripts["test:cache"]="testabulous cache --force"),l.scripts["testabulous:test"]||(l.scripts.test="testabulous test"),l.scripts["testabulous:help"]||(l.scripts["test:help"]="testabulous --help"),await re.writeFile("package.json",JSON.stringify(l,null,2),{encoding:"utf-8"}),console.log(ze.greenBright(`Your project ID and API key have been saved to .env.testabulous and this file referenced in testabulous.config.json. You should make sure that .env.testabulous is added to your .gitignore file. Alternatively, you can merge the TESTABULOUS_PROJECT_ID and TESTABULOUS_API_KEY environment variables into another .env file and update the config file accordingly, or set them elsewhere.
You can now start creating your test files in ./testabulous/tests and call 'npm run test' to run your tests. See https://docs.testabulous.com/category/getting-started for more information.`))}catch(s){throw console.log(s),Ke.isAxiosError(s)&&s.response&&(s.response.status===404||s.response.status===401)?new Error("Project ID or API key is invalid"):s}console.log(ze.greenBright("\u{1F44D} Project initialised"))}console.log(C.greenBright(Bt.textSync("Testabulous")));var T=new Rt;T.exitOverride(e=>{console.log(C.redBright(`\u{1F915} ${e}`)),process.exit(-1)});T.version("1.0.0").description("Testabulous E2E Testing Framework").option("-c, --config-file <value>","Local config file [./testabulous.config.json]").option("-e, --env-file <value>","File to load environment variables from").option("-p, --project-id <value>","Project ID").option("-k, --api-key <value>","API key").option("-r, --root-dir <value>","Test root directory [./testabulous]");T.command("init").description("Initialise testabulous project").action(async()=>{try{let e=await z(T.opts(),{});await U(e.cacheDir),await Me(e)}catch(e){console.log(C.redBright(`\u{1F915} Initialisation failed: ${e}`)),process.exit(-1)}});T.command("cache").option("-f, --file <value>","Specific test file to cache").option("-F, --force","Force re-cache of all test files").description("Parse and cache test files").action(async e=>{try{let r;try{r=await z(T.opts(),e),await U(r.cacheDir)}catch(t){console.log(C.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}await Ce(r)}catch(r){console.log(C.redBright(`\u{1F915} ${r}`)),process.exit(-1)}});T.command("test").option("-f, --file <value>","Specific test file to execute").option("-t, --test <value>","Specific test to execute").description("Start testabulous test runner").action(async e=>{let r;try{r=await z(T.opts(),e),await U(r.cacheDir)}catch(t){console.log(C.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}he("local",r).then(t=>{switch(t.result){case"pass":case"skip":process.exit(0);break;case"warn":process.exit(1);break;case"fail":process.exit(2);break;case"error":process.exit(3);break}}).catch(()=>{process.exit(3)})});T.command("remote").description("Start testabulous test runner for remote run").action(async e=>{let r;try{r=await z(T.opts(),e),await U(r.cacheDir)}catch(t){console.log(C.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}he("remote",r).then(t=>{switch(t.result){case"pass":case"skip":process.exit(0);break;case"warn":process.exit(1);break;case"fail":process.exit(2);break;case"error":process.exit(3);break}}).catch(()=>{process.exit(3)})});T.command("open").description("Open testabulous UI").option("-P, --port <value>","Port to run Testabulous UI [4001]").action(async e=>{let r;try{r=await z(T.opts(),e),await U(r.cacheDir)}catch(t){console.log(C.redBright(`\u{1F915} Initialisation failed: ${t}`)),process.exit(-1)}Pe(r).then(()=>{console.log(C.greenBright("Lingobt UI terminated"))}).catch(t=>{console.log(C.redBright(`\u{1F915} ${t}`)),process.exit(-1)})});try{T.parse(process.argv)}catch(e){console.log(C.redBright(`\u{1F915} ${e}`)),process.exit(-1)}
